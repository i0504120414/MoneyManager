name: Test Bank Connection & Add Account

on:
  workflow_dispatch:
    inputs:
      bank_type:
        description: 'Bank Type'
        required: true
        type: choice
        options:
          - hapoalim
          - beinleumi
          - union
          - amex
          - isracard
          - visaCal
          - max
          - otsarHahayal
          - discount
          - mercantile
          - mizrahi
          - leumi
          - massad
          - yahav
          - behatsdaa
          - beyahadBishvilha
          - oneZero
          - pagi
      
      userCode:
        description: 'User Code (hapoalim only)'
        required: false
      
      username:
        description: 'Username/ID - תעודת זהות (visaCal, leumi, mizrahi, max, otsarHahayal, union, beinleumi, massad, pagi, yahav)'
        required: false
      
      id:
        description: 'ID Number - תעודת זהות (discount, mercantile, isracard, amex, beyahadBishvilha, behatsdaa)'
        required: false
      
      password:
        description: 'Password - סיסמא (all banks)'
        required: false
      
      num:
        description: 'Branch/Account Number - מספר סניף (discount, mercantile only)'
        required: false
      
      card6Digits:
        description: 'Last 6 digits of card - 6 ספרות אחרונות של הכרטיס (isracard, amex only)'
        required: false
      
      nationalID:
        description: 'National ID - תעודת זהות (yahav only)'
        required: false
      
      email:
        description: 'Email (oneZero only)'
        required: false
      
      phoneNumber:
        description: 'Phone Number (oneZero only)'
        required: false
      
      otpCodeRetriever:
        description: 'OTP Code (oneZero only)'
        required: false
      
      otpLongTermToken:
        description: 'Long Term Token (oneZero only)'
        required: false

jobs:
  test_and_add:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read
      actions: write
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull Docker image
        run: docker pull ghcr.io/i0504120414/moneymanager:latest || (echo "Image not found, building locally..." && docker build -t ghcr.io/i0504120414/moneymanager:latest .)
      
      - name: Test Bank Connection
        env:
          BANK_TYPE: ${{ github.event.inputs.bank_type }}
          BANK_USERNAME: ${{ github.event.inputs.username }}
          USER_CODE: ${{ github.event.inputs.userCode }}
          ID: ${{ github.event.inputs.id }}
          PASSWORD: ${{ github.event.inputs.password }}
          NUM: ${{ github.event.inputs.num }}
          CARD_6_DIGITS: ${{ github.event.inputs.card6Digits }}
          NATIONAL_ID: ${{ github.event.inputs.nationalID }}
          EMAIL: ${{ github.event.inputs.email }}
          PHONE_NUMBER: ${{ github.event.inputs.phoneNumber }}
          OTP_CODE: ${{ github.event.inputs.otpCodeRetriever }}
          OTP_LONG_TERM_TOKEN: ${{ github.event.inputs.otpLongTermToken }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          PUPPETEER_EXECUTABLE_PATH: /usr/bin/chromium
          PUPPETEER_SKIP_CHROMIUM_DOWNLOAD: "true"
          DEBUG: '*,-puppeteer:*'
        run: |
          docker run --rm \
            -e BANK_TYPE="$BANK_TYPE" \
            -e BANK_USERNAME="$BANK_USERNAME" \
            -e USER_CODE="$USER_CODE" \
            -e ID="$ID" \
            -e PASSWORD="$PASSWORD" \
            -e NUM="$NUM" \
            -e CARD_6_DIGITS="$CARD_6_DIGITS" \
            -e NATIONAL_ID="$NATIONAL_ID" \
            -e EMAIL="$EMAIL" \
            -e PHONE_NUMBER="$PHONE_NUMBER" \
            -e OTP_CODE="$OTP_CODE" \
            -e OTP_LONG_TERM_TOKEN="$OTP_LONG_TERM_TOKEN" \
            -e SUPABASE_URL="$SUPABASE_URL" \
            -e SUPABASE_KEY="$SUPABASE_KEY" \
            -e PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium \
            -e PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=true \
            -e DEBUG='*,-puppeteer:*' \
            ghcr.io/i0504120414/moneymanager:latest \
            src/scripts/testConnection.js
      
      - name: Add Account to Database
        if: success()
        env:
          BANK_TYPE: ${{ github.event.inputs.bank_type }}
          BANK_USERNAME: ${{ github.event.inputs.username }}
          USER_CODE: ${{ github.event.inputs.userCode }}
          ID: ${{ github.event.inputs.id }}
          PASSWORD: ${{ github.event.inputs.password }}
          NUM: ${{ github.event.inputs.num }}
          CARD_6_DIGITS: ${{ github.event.inputs.card6Digits }}
          NATIONAL_ID: ${{ github.event.inputs.nationalID }}
          EMAIL: ${{ github.event.inputs.email }}
          PHONE_NUMBER: ${{ github.event.inputs.phoneNumber }}
          OTP_CODE: ${{ github.event.inputs.otpCodeRetriever }}
          OTP_LONG_TERM_TOKEN: ${{ github.event.inputs.otpLongTermToken }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          PUPPETEER_EXECUTABLE_PATH: /usr/bin/chromium
          PUPPETEER_SKIP_CHROMIUM_DOWNLOAD: "true"
          DEBUG: '*,-puppeteer:*'
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
        run: |
          docker run --rm \
            -e BANK_TYPE="$BANK_TYPE" \
            -e BANK_USERNAME="$BANK_USERNAME" \
            -e USER_CODE="$USER_CODE" \
            -e ID="$ID" \
            -e PASSWORD="$PASSWORD" \
            -e NUM="$NUM" \
            -e CARD_6_DIGITS="$CARD_6_DIGITS" \
            -e NATIONAL_ID="$NATIONAL_ID" \
            -e EMAIL="$EMAIL" \
            -e PHONE_NUMBER="$PHONE_NUMBER" \
            -e OTP_CODE="$OTP_CODE" \
            -e OTP_LONG_TERM_TOKEN="$OTP_LONG_TERM_TOKEN" \
            -e SUPABASE_URL="$SUPABASE_URL" \
            -e SUPABASE_KEY="$SUPABASE_KEY" \
            -e PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium \
            -e PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=true \
            -e DEBUG='*,-puppeteer:*' \
            -e GITHUB_TOKEN="$GITHUB_TOKEN" \
            ghcr.io/i0504120414/moneymanager:latest \
            src/scripts/addAccount.js
      
      - name: Save credentials to GitHub Secrets
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BANK_TYPE: ${{ github.event.inputs.bank_type }}
          BANK_USERNAME: ${{ github.event.inputs.username }}
          USER_CODE: ${{ github.event.inputs.userCode }}
          ID: ${{ github.event.inputs.id }}
          PASSWORD: ${{ github.event.inputs.password }}
          NUM: ${{ github.event.inputs.num }}
          CARD_6_DIGITS: ${{ github.event.inputs.card6Digits }}
          NATIONAL_ID: ${{ github.event.inputs.nationalID }}
          EMAIL: ${{ github.event.inputs.email }}
          PHONE_NUMBER: ${{ github.event.inputs.phoneNumber }}
          OTP_CODE: ${{ github.event.inputs.otpCodeRetriever }}
          OTP_LONG_TERM_TOKEN: ${{ github.event.inputs.otpLongTermToken }}
        run: |
          # Create credentials JSON
          CREDENTIALS_JSON=$(cat <<EOF
          {
            "bankType": "$BANK_TYPE",
            "username": "$BANK_USERNAME",
            "userCode": "$USER_CODE",
            "id": "$ID",
            "num": "$NUM",
            "card6Digits": "$CARD_6_DIGITS",
            "nationalID": "$NATIONAL_ID",
            "email": "$EMAIL",
            "phoneNumber": "$PHONE_NUMBER"
          }
          EOF
          )
          
          # Create secret name based on bank type and timestamp
          SECRET_NAME="ACC_${BANK_TYPE}_$(date +%s)"
          echo "Credentials would be saved as: $SECRET_NAME"
          echo "Note: Actual secret storage requires additional authentication setup"
      
      - name: Upload error screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: add-account-screenshots-${{ github.run_id }}
          path: app/screenshots/
          retention-days: 30
          if-no-files-found: ignore
