name: Test Bank Connection & Add Account

on:
  workflow_dispatch:
    inputs:
      bank_type:
        description: 'Bank Type'
        required: true
        type: choice
        options:
          - hapoalim
          - beinleumi
          - union
          - amex
          - isracard
          - visaCal
          - max
          - otsarHahayal
          - discount
          - mercantile
          - mizrahi
          - leumi
          - massad
          - yahav
          - behatsdaa
          - beyahadBishvilha
          - oneZero
          - pagi
      
      userCode:
        description: 'User Code (for hapoalim)'
        required: false
      
      username:
        description: 'Username (if applicable)'
        required: false
      
      id:
        description: 'ID (for banks requiring ID)'
        required: false
      
      password:
        description: 'Password'
        required: false
      
      num:
        description: 'Branch/Account Number (if applicable)'
        required: false
      
      card6Digits:
        description: 'Last 6 digits of card (for Isracard/Amex)'
        required: false
      
      nationalID:
        description: 'National ID (for Yahav)'
        required: false
      
      email:
        description: 'Email (for One Zero)'
        required: false
      
      phoneNumber:
        description: 'Phone Number (for One Zero)'
        required: false
      
      otpCodeRetriever:
        description: 'OTP Code (for One Zero)'
        required: false
      
      otpLongTermToken:
        description: 'Long Term Token (for One Zero)'
        required: false

jobs:
  test_and_add:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lastest'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Test Bank Connection
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          BANK_TYPE: ${{ github.event.inputs.bank_type }}
          USER_CODE: ${{ github.event.inputs.userCode }}
          USERNAME: ${{ github.event.inputs.username }}
          ID: ${{ github.event.inputs.id }}
          PASSWORD: ${{ github.event.inputs.password }}
          NUM: ${{ github.event.inputs.num }}
          CARD_6_DIGITS: ${{ github.event.inputs.card6Digits }}
          NATIONAL_ID: ${{ github.event.inputs.nationalID }}
          EMAIL: ${{ github.event.inputs.email }}
          PHONE_NUMBER: ${{ github.event.inputs.phoneNumber }}
          OTP_CODE: ${{ github.event.inputs.otpCodeRetriever }}
          OTP_LONG_TERM_TOKEN: ${{ github.event.inputs.otpLongTermToken }}
        run: node src/scripts/testBankConnection.js
      
      - name: Add Account to Database
        if: success()
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          BANK_TYPE: ${{ github.event.inputs.bank_type }}
          USER_CODE: ${{ github.event.inputs.userCode }}
          USERNAME: ${{ github.event.inputs.username }}
          ID: ${{ github.event.inputs.id }}
          PASSWORD: ${{ github.event.inputs.password }}
          NUM: ${{ github.event.inputs.num }}
          CARD_6_DIGITS: ${{ github.event.inputs.card6Digits }}
          NATIONAL_ID: ${{ github.event.inputs.nationalID }}
          EMAIL: ${{ github.event.inputs.email }}
          PHONE_NUMBER: ${{ github.event.inputs.phoneNumber }}
          OTP_CODE: ${{ github.event.inputs.otpCodeRetriever }}
          OTP_LONG_TERM_TOKEN: ${{ github.event.inputs.otpLongTermToken }}
        run: node src/scripts/addAccount.js
      
      - name: Upload Summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: account-setup-summary
          path: account-summary.json
          retention-days: 30
