name: Daily Transaction Sync

on:
  schedule:
    # Run every day at 8 AM UTC (10 AM Israel Standard Time)
    - cron: '0 8 * * *'
  
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      sync_mode:
        description: 'Sync Mode'
        required: true
        type: choice
        default: 'update'
        options:
          - update
          - max
      specific_account_id:
        description: 'Specific Account ID (optional, for single account sync)'
        required: false
        type: string

jobs:
  sync_transactions:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull Docker image or build locally
        run: docker pull ghcr.io/i0504120414/moneymanager:latest || (echo "Image not found, building locally..." && docker build -t ghcr.io/i0504120414/moneymanager:latest .)
      
      - name: Get all accounts from Supabase
        id: get_accounts
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: |
          # Get list of all active accounts from Supabase
          # This requires a helper script or API call
          echo "accounts_list=[]" >> $GITHUB_OUTPUT
      
      - name: Sync transactions for each account
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          SYNC_MODE: ${{ github.event.inputs.sync_mode || 'update' }}
          PUPPETEER_EXECUTABLE_PATH: /usr/bin/chromium
          PUPPETEER_SKIP_CHROMIUM_DOWNLOAD: "true"
          DEBUG: '*,-puppeteer:*'
        run: |
          # For now, this would iterate through all accounts and sync each one
          echo "üîÑ Starting daily transaction sync..."
          echo "Sync Mode: ${SYNC_MODE}"
          
          # In production, this would:
          # 1. Get all account IDs from Supabase
          # 2. For each account:
          #    a. Get credentials from GitHub Secrets (ACC_*)
          #    b. Run scxxxxxxxxxxx        #    c. Update transactions table
          #    d. Detect recurring transactions
          #    e. Create logs entry

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Detect recurring transactions
        if: always()
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: node src/scripts/detectRecurring.js
      
      - name: Create sync log
        if: always()
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: |
          # Log the sync operation results
          echo "üìù Sync completed at $(date)"
      
      - name: Send notifications
        if: always()
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: |
          # Send notifications for any issues or new recurring transactions
          echo "üìß Notifications would be sent here"
      
      - name: Upload sync results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: daily-sync-results-${{ github.run_id }}
          path: sync-results.json
          retention-days: 30
          if-no-files-found: ignore
      
      - name: Handle Failure
        if: failure()
        run: |
          echo "‚ùå Daily sync failed"
          exit 1
